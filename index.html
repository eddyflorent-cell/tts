<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Biblioth√®que de D√©pannage IT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --n1-color: #22c55e;   /* Neon green */
      --n2-color: #eab308;   /* Neon yellow */
      --admin-color: #f97316;/* Neon orange */
    }

    body {
      background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .glass {
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow:
        0 0 20px rgba(59, 130, 246, 0.25),
        0 0 40px rgba(236, 72, 153, 0.2);
    }

    .pill-active {
      border-color: rgba(248, 250, 252, 0.9);
      box-shadow: 0 0 12px rgba(248, 250, 252, 0.7);
    }

    .neon-border {
      box-shadow:
        0 0 10px rgba(56, 189, 248, 0.7),
        0 0 25px rgba(236, 72, 153, 0.5);
    }

    .card-hover {
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }

    .card-hover:hover {
      transform: translateY(-3px) scale(1.01);
      border-color: rgba(59, 130, 246, 0.7);
      box-shadow:
        0 0 12px rgba(59, 130, 246, 0.6),
        0 0 26px rgba(236, 72, 153, 0.5);
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.7);
      border-radius: 9999px;
    }

    .badge-n1 {
      color: #022c22;
      background: radial-gradient(circle at top left, #bbf7d0, #22c55e);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
    }

    .badge-n2 {
      color: #422006;
      background: radial-gradient(circle at top left, #fef9c3, #eab308);
      box-shadow: 0 0 12px rgba(234, 179, 8, 0.9);
    }

    .badge-admin {
      color: #431407;
      background: radial-gradient(circle at top left, #fed7aa, #f97316);
      box-shadow: 0 0 12px rgba(249, 115, 22, 0.9);
    }

    .category-chip {
      border-radius: 9999px;
      padding: 0.15rem 0.6rem;
      font-size: 0.7rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .glow-text {
      text-shadow:
        0 0 6px rgba(94, 234, 212, 0.9),
        0 0 18px rgba(129, 140, 248, 0.8);
    }

    .input-focus:focus {
      outline: none;
      box-shadow:
        0 0 0 1px rgba(248, 250, 252, 0.9),
        0 0 15px rgba(59, 130, 246, 0.9);
    }

    .transition-fast {
      transition: all 0.15s ease-out;
    }

    .rotate-icon {
      transition: transform 0.15s ease-out;
    }

    .details-open .rotate-icon {
      transform: rotate(90deg);
    }
	@media print {
  body {
    background: #ffffff !important;
    color: #000000 !important;
  }

  header,
  #addIncidentForm,
  #searchInput,
  #categoryFilters,
  #levelFilters,
  #resetBtn,
  #exportBtn,
  #importInput,
  #printAllBtn,
  button,
  .no-print {
    display: none !important;
  }

  #cardsContainer {
    display: block;
  }

  .glass,
  .card-hover {
    background: #ffffff !important;
    box-shadow: none !important;
    border: 1px solid #999999 !important;
    color: #000000 !important;
  }

  .badge-n1,
  .badge-n2,
  .badge-admin,
  .category-chip {
    background: #dddddd !important;
    color: #000000 !important;
    border-color: #bbbbbb !important;
    box-shadow: none !important;
  }

  article {
    break-inside: avoid;
    page-break-inside: avoid;
    margin-bottom: 16px;
  }

  article + article {
    page-break-before: always;
  }
}

  </style>
</head>
<body class="min-h-screen">
  <div class="min-h-screen px-4 py-6 sm:px-8 sm:py-8 lg:px-16 lg:py-10">
    <!-- Header -->
    <header class="max-w-7xl mx-auto mb-6 sm:mb-8">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
        <div>
          <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-sky-100 glow-text">
            TOTAL TROUBLE <span class="text-pink-400">SHOOTING</span>
          </h1>
          <p class="mt-2 text-sm sm:text-base text-slate-300">
            Biblioth√®que centralis√©e de d√©pannage IT pour l'√©cosyst√®me Microsoft 365.
          </p>
        </div>
        <button
          id="aiSuggestionBtn"
          class="inline-flex items-center justify-center px-4 py-2 rounded-xl glass neon-border text-sm font-semibold text-sky-50 hover:bg-sky-900/60 transition-fast"
        >
          <span class="mr-2 text-lg">‚ú®</span>
          <span>Suggestion IA</span>
        </button>
      </div>
	  
	  <div class="flex gap-2">
  <button id="exportBtn"
    class="px-3 py-2 rounded-xl glass text-xs font-semibold text-sky-100">
    Export JSON
  </button>
  <button id="exportWithImagesBtn"
    class="px-3 py-2 rounded-xl glass text-xs font-semibold text-amber-100 border border-amber-400/40">
    Export JSON + images
  </button>
  <label
    class="px-3 py-2 rounded-xl glass text-xs font-semibold text-pink-200 cursor-pointer">
    Import JSON
    <input id="importInput" type="file" accept="application/json" class="hidden" />
  </label>
  <button id="printAllBtn"
    class="px-3 py-2 rounded-xl glass text-xs font-semibold text-slate-100 border border-slate-500/60">
    Imprimer tout
  </button>
  <button id="resetBtn"
    class="px-3 py-2 rounded-xl glass text-xs font-semibold text-red-200 border border-red-500/60">
    R√©initialiser la biblioth√®que
  </button>
</div>


    </header>

    <!-- Search & Filters -->
    <section class="max-w-7xl mx-auto mb-6 sm:mb-8 glass rounded-2xl p-4 sm:p-5">
      <!-- Search -->
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex-1 w-full">
          <label for="searchInput" class="block text-xs font-semibold tracking-wide text-slate-400 uppercase mb-1">
            Recherche globale
          </label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
              üîç
            </span>
            <input
              id="searchInput"
              type="text"
              placeholder="Rechercher dans le titre, le probl√®me, la root cause, la solution..."
              class="w-full pl-9 pr-3 py-2.5 rounded-xl bg-slate-900/70 border border-slate-600/70 text-sm text-slate-100 placeholder:text-slate-500 input-focus"
            />
          </div>
        </div>
        <div class="flex items-center gap-2 text-xs text-slate-400">
          <span id="countVisible" class="font-semibold text-sky-300"></span>
          <span class="hidden xs:inline">fiches visibles</span>
        </div>
      </div>

      <!-- Filters -->
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Category filters -->
        <div>
          <p class="text-xs font-semibold tracking-wide text-slate-400 uppercase mb-2">
            Cat√©gories
          </p>
          <div id="categoryFilters" class="flex flex-wrap gap-2">
            <!-- Pills generated by JS -->
          </div>
        </div>
        <!-- Level filters -->
        <div>
          <p class="text-xs font-semibold tracking-wide text-slate-400 uppercase mb-2">
            Niveaux d'accr√©ditation
          </p>
          <div id="levelFilters" class="flex flex-wrap gap-2">
            <!-- Pills generated by JS -->
          </div>
        </div>
      </div>
    </section>

    <!-- Main content -->
    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-7 items-start">
      <!-- Cards -->
      <section class="lg:col-span-2">
        <div
  id="cardsContainer"
  class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-5 items-start"
>

          <!-- Cards injected by JS -->
        </div>
        <p
          id="noResults"
          class="hidden mt-4 text-center text-sm text-slate-400"
        >
          Aucune fiche ne correspond aux filtres/recherches actuels.
        </p>
      </section>

<div id="imageAiModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/70"></div>
  <div class="relative w-full max-w-2xl glass rounded-2xl p-4 sm:p-5 border border-slate-600/60">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h3 class="text-base sm:text-lg font-semibold text-sky-100">Image manquante ‚Äì suggestion IA</h3>
        <p class="text-xs text-slate-400 mt-1">Copie le prompt dans ton g√©n√©rateur d‚Äôimages. Tu peux aussi coller un data-URI base64 pour l‚Äôattacher √† la fiche.</p>
      </div>
      <button id="closeImageAiModal" type="button" class="px-2 py-1 rounded-lg border border-slate-500/70 text-slate-200 hover:bg-slate-800/80 transition-fast">‚úï</button>
    </div>

    <div class="mt-4 grid grid-cols-1 gap-3">
      <div>
        <label class="block text-xs font-semibold text-slate-300 mb-1">Prompt (√† copier)</label>
        <textarea id="imageAiPrompt" rows="6" class="w-full px-2.5 py-2 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 input-focus text-xs"></textarea>
        <div class="mt-2 flex flex-wrap gap-2">
          <button id="copyImageAiPrompt" type="button" class="px-3 py-2 rounded-xl bg-slate-900/70 border border-slate-500/70 text-xs font-semibold text-slate-100 hover:bg-slate-800/80 transition-fast">üìã Copier le prompt</button>
        </div>
      </div>

      <div class="mt-2 rounded-xl border border-slate-600/60 bg-slate-900/35 p-3">
        <div class="flex items-center justify-between gap-2">
          <div>
            <p class="text-xs font-semibold text-slate-200">üß© G√©n√©rer un mock ‚Äúscreenshot‚Äù (Enterprise)</p>
            <p class="text-[11px] text-slate-400 mt-0.5">G√©n√®re une fausse fen√™tre r√©aliste (Windows/macOS/iOS/Android/Azure/Exchange/AD‚Ä¶) et l‚Äôattache directement √† la fiche.</p>
          </div>
        </div>
        <div class="mt-2 flex flex-col sm:flex-row gap-2">
          <select id="mockTemplateSelect" class="w-full sm:w-auto px-2.5 py-2 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 input-focus text-xs">
            <option value="auto">Auto (selon la cat√©gorie)</option>
            <option value="windows11_dialog">Windows 11 ‚Äî Bo√Æte de dialogue</option>
            <option value="windows11_toast">Windows 11 ‚Äî Notification toast</option>
            <option value="windows_security_cred">Windows ‚Äî Invite d‚Äôidentifiants (Credential)</option>
            <option value="windows_bsod">Windows ‚Äî BSOD (√©cran bleu)</option>
            <option value="macos_alert">macOS ‚Äî Alerte syst√®me</option>
            <option value="macos_keychain">macOS ‚Äî Invite Trousseaux (Keychain)</option>
            <option value="ios_alert">iOS ‚Äî Alerte</option>
            <option value="ios_settings_banner">iOS ‚Äî Banni√®re R√©glages</option>
            <option value="android_dialog">Android ‚Äî Dialog</option>
            <option value="android_notification">Android ‚Äî Notification</option>
            <option value="browser_edge_error">Edge/Chrome ‚Äî Page d‚Äôerreur</option>
            <option value="teams_error">Teams ‚Äî Erreur/connexion</option>
            <option value="vpn_client_error">VPN (Cisco/Forti) ‚Äî Erreur</option>
            <option value="azure_portal_error">Azure Portal ‚Äî Erreur</option>
            <option value="entra_signin_error">Entra ID ‚Äî Erreur de connexion</option>
            <option value="exchange_outlook_error">Exchange/Outlook ‚Äî Erreur</option>
            <option value="active_directory_logon">AD ‚Äî √âchec d‚Äôouverture de session</option>
</select>
          <button id="generateMockImageBtn" type="button" class="px-3 py-2 rounded-xl bg-gradient-to-r from-sky-400 to-emerald-400 text-slate-950 text-xs font-semibold hover:from-sky-300 hover:to-emerald-300 transition-fast">
            üñºÔ∏è G√©n√©rer & attacher
          </button>
        </div>
        <p class="text-[11px] text-slate-500 mt-2">Astuce : si tu veux un rendu encore plus ‚Äúvrai‚Äù, garde des messages courts (1‚Äì2 lignes) et mets le code erreur dans le titre.</p>
      </div>

      <div>
        <label class="block text-xs font-semibold text-slate-300 mb-1">Coller une image en base64 (data:image/...;base64,...)</label>

        <div id="imageDropZone" class="mt-2 rounded-xl border border-dashed border-slate-500/70 bg-slate-900/40 p-4 text-center transition-fast hover:bg-slate-900/55">
          <p class="text-xs text-slate-200 font-semibold">Glisse-d√©pose une image ici</p>
          <p class="mt-1 text-[11px] text-slate-400">ou clique pour s√©lectionner un fichier (PNG/JPG/WebP). L‚Äôimage sera automatiquement compress√©e et attach√©e √† la fiche.</p>
          <input id="imageFileInput" type="file" accept="image/*" class="hidden" />
          <img id="imageDropPreview" class="hidden mt-3 w-full max-h-48 object-contain rounded-lg border border-slate-700/70" alt="Pr√©visualisation" />
        </div>
<textarea id="imageBase64Input" rows="3" class="w-full px-2.5 py-2 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 input-focus text-xs" placeholder="data:image/png;base64,iVBORw0KGgoAAA..."></textarea>
        <div class="mt-2 flex flex-wrap gap-2">
          <button id="attachBase64ToIncident" type="button" class="px-3 py-2 rounded-xl bg-gradient-to-r from-amber-400 to-pink-400 text-slate-950 text-xs font-semibold hover:from-amber-300 hover:to-pink-300 transition-fast">üìé Attacher √† la fiche</button>
          <button id="clearBase64Input" type="button" class="px-3 py-2 rounded-xl bg-slate-900/70 border border-slate-500/70 text-xs font-semibold text-slate-100 hover:bg-slate-800/80 transition-fast">üßπ Vider</button>
        </div>
      </div>

      <p id="imageAiModalContext" class="text-[11px] text-slate-400"></p>
    </div>
  </div>
</div>

<div id="toast"
     class="fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-xs sm:text-sm
            bg-emerald-600/90 text-white shadow-lg hidden">
</div>

      <!-- Form -->
      <aside class="glass rounded-2xl p-4 sm:p-5 lg:sticky lg:top-6 max-h-[80vh] overflow-y-auto scrollbar-thin">
        <h2 class="text-lg font-semibold mb-3 text-sky-100">
          Ajouter une nouvelle panne
        </h2>
        <p class="text-xs text-slate-400 mb-4">
          Compl√®te le formulaire pour enrichir la biblioth√®que avec tes propres cas de d√©pannage.
        </p>
        <form id="addIncidentForm" class="space-y-3 text-sm">
          <div>
            <label class="block text-xs font-semibold text-slate-300 mb-1">Titre</label>
            <input
              type="text"
              name="title"
              required
              class="w-full px-2.5 py-1.5 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 placeholder:text-slate-500 input-focus"
              placeholder="Ex : BSOD au d√©marrage sur Windows 11"
            />
          </div>
<div>
  <label class="block text-xs font-semibold text-slate-300 mb-1">
    Auteur / Technicien (optionnel)
  </label>
  <input
    type="text"
    name="author"
    class="w-full px-2.5 py-1.5 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 placeholder:text-slate-500 input-focus"
    placeholder="Ex : J. Martin"
  />
</div>

          <div>
            <label class="block text-xs font-semibold text-slate-300 mb-1">Cat√©gorie</label>
<input
  type="text"
  name="category"
  required
  list="categoryList"
  class="w-full px-2.5 py-1.5 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 input-focus"
  placeholder="Ex : Windows, Poste de travail, VPN..."
/>
<datalist id="categoryList">
  <option value="Windows"></option>
  <option value="Poste de travail"></option>
  <option value="Mac"></option>
  <option value="Android"></option>
  <option value="iOS"></option>
  <option value="Imprimantes / Copieurs"></option>
  <option value="Meeting room"></option>
  <option value="Outlook"></option>
  <option value="SharePoint"></option>
  <option value="Teams"></option>
  <option value="OneDrive"></option>
  <option value="VPN"></option>
  <option value="Azure"></option>
  <option value="Exchange"></option>
</datalist>

          </div>

          <div>
            <label class="block text-xs font-semibold text-slate-300 mb-1">Niveau</label>
            <select
              name="level"
              required
              class="w-full px-2.5 py-1.5 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 input-focus"
            >
              <option value="">S√©lectionner...</option>
              <option>N1</option>
              <option>N2</option>
              <option>Admin</option>
            </select>
          </div>

          <div>
		  <div>
  <label class="block text-xs font-semibold text-slate-300 mb-1">
    URL / chemin de l'image (optionnel)
  </label>
  <input
    type="text"
    name="image"
    class="w-full px-2.5 py-1.5 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 placeholder:text-slate-500 input-focus"
    placeholder="Ex : images/bsod.png ou https://..."
  />
</div>
<div>
  <label class="block text-xs font-semibold text-slate-300 mb-1">
    Tags (s√©par√©s par des virgules)
  </label>
  <input
    type="text"
    name="tags"
    class="w-full px-2.5 py-1.5 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 placeholder:text-slate-500 input-focus"
    placeholder="Ex : r√©seau, VPN, performance..."
  />
</div>

            <label class="block text-xs font-semibold text-slate-300 mb-1">Probl√®me (sympt√¥mes)</label>
            <textarea
              name="problem"
              required
              rows="2"
              class="w-full px-2.5 py-1.5 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 placeholder:text-slate-500 input-focus"
              placeholder="Description synth√©tique des sympt√¥mes observ√©s..."
            ></textarea>
          </div>

          <div>
            <label class="block text-xs font-semibold text-slate-300 mb-1">Root Cause</label>
            <textarea
              name="rootCause"
              required
              rows="2"
              class="w-full px-2.5 py-1.5 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 placeholder:text-slate-500 input-focus"
              placeholder="Origine technique identifi√©e / probable..."
            ></textarea>
          </div>

          <div>
            <label class="block text-xs font-semibold text-slate-300 mb-1">Solution de contournement</label>
            <textarea
              name="workaround"
              required
              rows="2"
              class="w-full px-2.5 py-1.5 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 placeholder:text-slate-500 input-focus"
              placeholder="Action rapide √† appliquer pour d√©bloquer l'utilisateur..."
            ></textarea>
          </div>

          <div>
            <label class="block text-xs font-semibold text-slate-300 mb-1">Solution d√©finitive</label>
            <textarea
              name="solution"
              required
              rows="2"
              class="w-full px-2.5 py-1.5 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 placeholder:text-slate-500 input-focus"
              placeholder="R√©solution p√©renne √† mettre en place (corriger la cause)..."
            ></textarea>
          </div>

          <div>
            <label class="block text-xs font-semibold text-slate-300 mb-1">Fiche de d√©pannage (√©tapes)</label>
            <textarea
              name="steps"
              required
              rows="3"
              class="w-full px-2.5 py-1.5 rounded-lg bg-slate-900/70 border border-slate-600/70 text-slate-100 placeholder:text-slate-500 input-focus"
              placeholder="Guide √©tape par √©tape, 1 action par ligne..."
            ></textarea>
          </div>

          <div class="mt-2 flex flex-col sm:flex-row gap-2">
  <button
    id="submitIncidentBtn"
    type="submit"
    class="w-full sm:w-auto inline-flex items-center justify-center px-3 py-2 rounded-xl bg-gradient-to-r from-sky-500 to-pink-500 text-slate-950 font-semibold hover:from-sky-400 hover:to-pink-400 transition-fast"
  >
    Ajouter la fiche
  </button>
  <button
    id="cancelEditBtn"
    type="button"
    class="hidden w-full sm:w-auto px-3 py-2 rounded-xl border border-slate-500/70 text-xs font-semibold text-slate-200 bg-slate-900/70 hover:bg-slate-800/80 transition-fast"
  >
    ‚ùå Annuler
  </button>
</div>

   </form>
   </aside>
   </main>
   
<script>
// -----------------------------
// Donn√©es initiales (JSON)
// -----------------------------

const STORAGE_KEY = "tt_incidents_v1";

const incidents = [];
const aiSuggestionsPool = [];

let nextId = incidents.length + 1;

// -----------------------------
// Persistance localStorage
// -----------------------------
function saveIncidentsToStorage() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(incidents));
  } catch (e) {
    console.warn("Impossible de sauvegarder dans localStorage", e);
  }
}

function loadIncidentsFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    if (Array.isArray(parsed) && parsed.length > 0) {
      incidents.length = 0;
      parsed.forEach(i => incidents.push(i));
      nextId = incidents.reduce((max, i) => Math.max(max, i.id || 0), 0) + 1;
    }
  } catch (e) {
    console.warn("Donn√©es locales corrompues, on repart sur la version embarqu√©e.", e);
  }
}
function showToast(message, type = "success") {
  const toast = document.getElementById("toast");
  if (!toast) return;

  toast.textContent = message;

  // couleur selon le type
  if (type === "success") {
    toast.className = "fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-xs sm:text-sm bg-emerald-600/90 text-white shadow-lg";
  } else if (type === "error") {
    toast.className = "fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-xs sm:text-sm bg-red-600/90 text-white shadow-lg";
  } else {
    toast.className = "fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-xs sm:text-sm bg-slate-700/90 text-white shadow-lg";
  }

  toast.classList.remove("hidden");

  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(() => {
    toast.classList.add("hidden");
  }, 2500);
}

// -----------------------------
// Helpers UI
// -----------------------------
const categoryOptions = [
  "Windows",
  "Poste de travail",
  "Mac",
  "Android",
  "iOS",
  "Imprimantes / Copieurs",
  "Meeting room",
  "Outlook",
  "SharePoint",
  "Teams",
  "OneDrive",
  "VPN",
  "Azure",
  "Exchange"
];

const levelOptions = ["N1", "N2", "Admin"];

const state = {
  search: "",
  category: "ALL",
  level: "ALL",
  favoritesOnly: false
};
let editingIncidentId = null;
let filtersListenersBound = false;

function getIncidentById(id) {
  return incidents.find(inc => inc.id === id);
}

function deleteIncidentById(id) {
  const idx = incidents.findIndex(inc => inc.id === id);
  if (idx !== -1) {
    incidents.splice(idx, 1);
  }
}

const cardsContainer = document.getElementById("cardsContainer");
const noResults = document.getElementById("noResults");
const countVisible = document.getElementById("countVisible");

function getLevelBadgeClass(level) {
  if (level === "N1") return "badge-n1";
  if (level === "N2") return "badge-n2";
  return "badge-admin";
}

function getLevelLabel(level) {
  if (level === "N1") return "N1 - Frontline";
  if (level === "N2") return "N2 - Expert";
  return "Admin - Global";
}

function createPill(label, value, type) {
  const button = document.createElement("button");
  button.type = "button";
  button.dataset.value = value;
  button.dataset.type = type;
  button.className =
    "px-3 py-1 rounded-full text-xs font-semibold border border-slate-500/70 bg-slate-900/70 text-slate-200 hover:bg-slate-800/80 transition-fast";
  button.textContent = label;
  return button;
}

function renderFilters() {
  const categoryFilters = document.getElementById("categoryFilters");
  const levelFilters = document.getElementById("levelFilters");

  categoryFilters.innerHTML = "";
  levelFilters.innerHTML = "";

  // Cat√©gories dynamiques = suggestions (categoryOptions) + cat√©gories r√©ellement pr√©sentes
  const categorySet = new Set(categoryOptions);
  incidents.forEach(inc => {
    if (inc && typeof inc.category === "string" && inc.category.trim()) {
      categorySet.add(inc.category.trim());
    }
  });
  const allCategories = Array.from(categorySet).sort((a, b) =>
    a.localeCompare(b, "fr", { sensitivity: "base" })
  );

  // Bouton "Toutes"
  const allCat = createPill("Toutes", "ALL", "category");
  if (state.category === "ALL") allCat.classList.add("pill-active");
  categoryFilters.appendChild(allCat);

  // Boutons cat√©gories
  allCategories.forEach(cat => {
    const btn = createPill(cat, cat, "category");
    if (state.category === cat) btn.classList.add("pill-active");
    categoryFilters.appendChild(btn);
  });

  // Mise √† jour du datalist
  const categoryList = document.getElementById("categoryList");
  if (categoryList) {
    categoryList.innerHTML = "";
    allCategories.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      categoryList.appendChild(opt);
    });
  }

  // Bouton "Tous" niveaux
  const allLevel = createPill("Tous", "ALL", "level");
  if (state.level === "ALL") allLevel.classList.add("pill-active");
  levelFilters.appendChild(allLevel);

  // Boutons niveaux
  levelOptions.forEach(lvl => {
    const btn = createPill(lvl, lvl, "level");
    if (state.level === lvl) btn.classList.add("pill-active");
    levelFilters.appendChild(btn);
  });

  // Bouton "‚≠ê Favoris seulement" (idempotent)
  let favToggle = document.getElementById("favoritesOnlyButton");
  if (!favToggle) {
    favToggle = document.createElement("button");
    favToggle.id = "favoritesOnlyButton";
    favToggle.type = "button";
    favToggle.className =
      "mt-2 px-3 py-1 rounded-full text-xs font-semibold border border-slate-500/70 bg-slate-900/70 text-yellow-300 hover:bg-slate-800/80 transition-fast";
    favToggle.textContent = "‚≠ê Favoris seulement";
    favToggle.addEventListener("click", () => {
      state.favoritesOnly = !state.favoritesOnly;
      favToggle.classList.toggle("pill-active", state.favoritesOnly);
      renderCards();
    });
  }
  favToggle.classList.toggle("pill-active", state.favoritesOnly);
  levelFilters.parentElement.appendChild(favToggle);

  // Listeners (bind une seule fois)
  if (!filtersListenersBound) {
    categoryFilters.addEventListener("click", onFilterClick);
    levelFilters.addEventListener("click", onFilterClick);
    filtersListenersBound = true;
  }
}

function onFilterClick(e) {
  const btn = e.target.closest("button");
  if (!btn) return;
  const { value, type } = btn.dataset;
  if (!value || !type) return;

  if (type === "category") {
    state.category = value;
    const siblings = btn.parentElement.querySelectorAll("button");
    siblings.forEach(b => b.classList.remove("pill-active"));
    btn.classList.add("pill-active");
  } else if (type === "level") {
    state.level = value;
    const siblings = btn.parentElement.querySelectorAll("button");
    siblings.forEach(b => b.classList.remove("pill-active"));
    btn.classList.add("pill-active");
  }
  renderCards();
}

function matchesSearch(incident, term) {
  if (!term) return true;
  const t = term.toLowerCase();
  const fields = [
    incident.title,
    incident.category,
    incident.level,
    incident.author || "",
    incident.problem,
    incident.rootCause,
    incident.workaround,
    incident.solution,
    (incident.steps || []).join(" "),
    (incident.tags || []).join(" "),
    incident.image || "",
    incident.createdAt || "",
    incident.updatedAt || ""
  ];
  const text = fields.join(" ").toLowerCase();
  return text.includes(t);
}


function matchesFilters(incident) {
  const catOk = state.category === "ALL" || incident.category === state.category;
  const lvlOk = state.level === "ALL" || incident.level === state.level;
  const favOk = !state.favoritesOnly || incident.favorite;
  return catOk && lvlOk && favOk;
}

function scoreIncidentAgainstSearch(incident, term) {
  if (!term) return 0;
  const t = term.toLowerCase();
  let score = 0;

  const title = (incident.title || "").toLowerCase();
  const problem = (incident.problem || "").toLowerCase();
  const tags = (incident.tags || []).join(" ").toLowerCase();

  if (title.includes(t)) score += 3;
  if (problem.includes(t)) score += 2;
  if (tags.includes(t)) score += 1;

  return score;
}

function suggestFromPool() {
  const term = state.search || "";

  // On filtre le pool avec les m√™mes r√®gles que les cartes
  const poolCandidates = aiSuggestionsPool.filter(inc =>
    matchesFilters(inc) && matchesSearch(inc, term)
  );

  if (poolCandidates.length === 0) {
    return null;
  }

  // Sans terme de recherche : suggestion al√©atoire parmi les candidats filtr√©s
  if (!term) {
    return poolCandidates[Math.floor(Math.random() * poolCandidates.length)];
  }

  // Avec recherche : on cherche le meilleur score
  let best = null;
  let bestScore = 0;
  for (const inc of poolCandidates) {
    const s = scoreIncidentAgainstSearch(inc, term);
    if (s > bestScore) {
      bestScore = s;
      best = inc;
    }
  }
  return best || poolCandidates[0];
}

// Crochet pour l‚ÄôIA externe (√† brancher plus tard sur un backend)

// -----------------------------
// Images : suggestion IA + attachement base64
// -----------------------------
let _imageAiTargetIncidentId = null;

function buildImageSuggestionPrompt(incident) {
  const title = incident?.title || "";
  const category = incident?.category || "";
  const problem = incident?.problem || "";
  const tags = Array.isArray(incident?.tags) ? incident.tags.join(", ") : "";

  // Objectif : une image "Enterprise KB" quasi indiscernable d‚Äôun vrai screenshot,
  // MAIS il s‚Äôagit d‚Äôun mock recr√©√© (pas une capture r√©elle), sans watermark, sans styles artistiques.
  return (
    "Ultra realistic UI mock screenshot for an enterprise IT knowledge base.\n" +
    "Must look like an authentic system/application screenshot (NOT an illustration, NOT futuristic, NOT cartoon).\n" +
    "Typography: Segoe UI (Windows), SF Pro (Apple), Roboto (Android) depending on the platform.\n" +
    "No watermark, no fake AI art, no neon effects. Crisp readable text.\n" +
    "16:9 (1280x720).\n\n" +
    `Scenario title: ${title}\n` +
    `Product / Environment: ${category}\n` +
    (problem ? `Error description (use as the main dialog text): ${problem}\n` : "") +
    (tags ? `Keywords: ${tags}\n` : "") +
    "\nPlatform instruction (choose the most appropriate):\n" +
    "- Windows 11 system dialog OR app dialog (Outlook/Teams/Edge)\n" +
    "- macOS system alert\n" +
    "- iOS alert\n" +
    "- Android dialog\n" +
    "- Azure Portal error pane\n" +
    "- Exchange/Outlook error dialog\n" +
    "- Active Directory logon failure dialog\n\n" +
    "Layout rules:\n" +
    "- Realistic window chrome, correct spacing, subtle shadow\n" +
    "- Include an error/warning/info icon where appropriate\n" +
    "- Buttons: OK / Cancel / Retry (choose logically)\n" +
    "- Keep text short and plausible (1‚Äì3 lines).\n"
  );
}

function openImageAiModal(incident) {
  _imageAiTargetIncidentId = incident?.id ?? null;

  const modal = document.getElementById("imageAiModal");
  const promptEl = document.getElementById("imageAiPrompt");
  const base64El = document.getElementById("imageBase64Input");
  const ctxEl = document.getElementById("imageAiModalContext");

  if (!modal || !promptEl || !base64El) return;

  promptEl.value = buildImageSuggestionPrompt(incident);
  base64El.value = "";

  const imgVal = incident?.image ? String(incident.image) : "(aucune)";
  ctxEl.textContent = `Fiche #${incident?.id} ‚Äî ${incident?.title || ""} ‚Ä¢ image actuelle : ${imgVal}`;

  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

function closeImageAiModal() {
  const modal = document.getElementById("imageAiModal");
  if (!modal) return;
  modal.classList.add("hidden");
  modal.classList.remove("flex");
  _imageAiTargetIncidentId = null;
}


// -----------------------------
// Enterprise UI Mock Generator (Canvas)
// -----------------------------
function _mkCanvas(w, h) {
  const c = document.createElement("canvas");
  c.width = w; c.height = h;
  const ctx = c.getContext("2d");
  // Default background (subtle)
  ctx.fillStyle = "#eef2f7";
  ctx.fillRect(0, 0, w, h);
  return { c, ctx };
}

function _wrapText(ctx, text, x, y, maxWidth, lineHeight, maxLines = 6) {
  const words = String(text || "").split(/\s+/).filter(Boolean);
  let line = "";
  let lines = 0;
  for (let n = 0; n < words.length; n++) {
    const testLine = line + words[n] + " ";
    const metrics = ctx.measureText(testLine);
    if (metrics.width > maxWidth && n > 0) {
      ctx.fillText(line.trim(), x, y);
      line = words[n] + " ";
      y += lineHeight;
      lines++;
      if (lines >= maxLines) return;
    } else {
      line = testLine;
    }
  }
  if (lines < maxLines) ctx.fillText(line.trim(), x, y);
}

function generateEnterpriseMockImageDataUrl(template, incident) {
  const title = incident?.title || "Erreur";
  const problem = incident?.problem || "Une erreur est survenue.";
  const category = incident?.category || "Syst√®me";

  // Auto template selection (best-effort) based on category/title
  if (!template || template === "auto") {
    const c = String(category || "").toLowerCase();
    const t = String(title || "").toLowerCase();
    const p = String(problem || "").toLowerCase();
    const hay = (c + " " + t + " " + p);

    if (/(azure|entra|adfs|oauth|tenant|subscription|resource group|arm)/.test(hay)) template = "azure_portal_error";
    else if (/(entra|azure ad|aad|signin|sign-in|mfa|conditional access)/.test(hay)) template = "entra_signin_error";
    else if (/(exchange|outlook|mailbox|autodiscover|ost|pst|mapi)/.test(hay)) template = "exchange_outlook_error";
    else if (/(teams)/.test(hay)) template = "teams_error";
    else if (/(vpn|forti|cisco|anyconnect|pulse|globalprotect)/.test(hay)) template = "vpn_client_error";
    else if (/(ios|iphone|ipad)/.test(hay)) template = "ios_alert";
    else if (/(android)/.test(hay)) template = "android_dialog";
    else if (/(mac|macos|os x)/.test(hay)) template = "macos_alert";
    else if (/(edge|chrome|browser|http|ssl|certificate|hsts|dns|proxy)/.test(hay)) template = "browser_edge_error";
    else if (/(active directory|ad |domain controller|kerberos|ntlm|gpo|logon|ou|dsa)/.test(hay)) template = "active_directory_logon";
    else template = "windows11_dialog";
  }

  // 1280x720 = vrai format ‚Äúscreenshot‚Äù
  const W = 1280, H = 720;

  const { c, ctx } = _mkCanvas(W, H);

  // Helpers
  const shadow = () => {
    ctx.shadowColor = "rgba(0,0,0,0.22)";
    ctx.shadowBlur = 28;
    ctx.shadowOffsetY = 14;
  };
  const noShadow = () => {
    ctx.shadowColor = "transparent";
    ctx.shadowBlur = 0;
    ctx.shadowOffsetY = 0;
    ctx.shadowOffsetX = 0;
  };

  const drawButton = (x, y, w, h, label, primary=false) => {
    ctx.save();
    ctx.fillStyle = primary ? "#0f6cbd" : "#f3f4f6";
    ctx.strokeStyle = primary ? "#0f6cbd" : "#c9cdd3";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.roundRect(x, y, w, h, 8);
    ctx.fill();
    ctx.stroke();
    ctx.fillStyle = primary ? "#fff" : "#111827";
    ctx.font = "16px Segoe UI, Arial";
    ctx.fillText(label, x + 16, y + 26);
    ctx.restore();
  };

  // Some browsers don‚Äôt have roundRect
  if (!ctx.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
      r = Math.min(r, w/2, h/2);
      this.beginPath();
      this.moveTo(x+r, y);
      this.arcTo(x+w, y, x+w, y+h, r);
      this.arcTo(x+w, y+h, x, y+h, r);
      this.arcTo(x, y+h, x, y, r);
      this.arcTo(x, y, x+w, y, r);
      this.closePath();
      return this;
    };
  }

  // Template switch
  switch (template) {
    case "windows11_dialog": {
      // Desktop background
      ctx.fillStyle = "#e9eef6";
      ctx.fillRect(0, 0, W, H);

      shadow();
      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#e5e7eb";
      ctx.lineWidth = 2;

      const x=260, y=170, w=760, h=380;
      ctx.roundRect(x, y, w, h, 14);
      ctx.fill(); ctx.stroke();
      noShadow();

      // Title bar
      ctx.fillStyle = "#f8fafc";
      ctx.fillRect(x, y, w, 54);
      ctx.strokeStyle = "#e5e7eb";
      ctx.beginPath(); ctx.moveTo(x, y+54); ctx.lineTo(x+w, y+54); ctx.stroke();

      ctx.fillStyle = "#111827";
      ctx.font = "16px Segoe UI, Arial";
      ctx.fillText(category || "Microsoft Windows", x+22, y+34);

      // Close button
      ctx.fillStyle = "#111827";
      ctx.font = "20px Segoe UI, Arial";
      ctx.fillText("‚úï", x+w-34, y+36);

      // Icon
      ctx.fillStyle = "#fbbf24"; // amber
      ctx.beginPath(); ctx.arc(x+78, y+160, 26, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = "#111827";
      ctx.font = "28px Segoe UI, Arial";
      ctx.fillText("!", x+70, y+170);

      // Text
      ctx.fillStyle = "#111827";
      ctx.font = "20px Segoe UI, Arial";
      _wrapText(ctx, problem, x+125, y+142, 560, 30, 6);

      // Buttons
      drawButton(x+w-240, y+h-78, 100, 40, "Annuler", false);
      drawButton(x+w-126, y+h-78, 100, 40, "OK", true);

      break;
    }
    case "windows11_toast": {
      ctx.fillStyle = "#e9eef6";
      ctx.fillRect(0, 0, W, H);

      shadow();
      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#e5e7eb";
      const x=780, y=70, w=430, h=160;
      ctx.roundRect(x, y, w, h, 14);
      ctx.fill(); ctx.stroke();
      noShadow();

      ctx.fillStyle = "#111827";
      ctx.font = "14px Segoe UI, Arial";
      ctx.fillText(category || "Windows", x+18, y+34);

      ctx.fillStyle = "#374151";
      ctx.font = "16px Segoe UI, Arial";
      _wrapText(ctx, title || "Notification", x+18, y+62, w-36, 22, 2);

      ctx.fillStyle = "#111827";
      ctx.font = "14px Segoe UI, Arial";
      _wrapText(ctx, problem, x+18, y+92, w-36, 20, 3);
      break;
    }
    case "macos_alert": {
      // macOS wallpaper blur impression
      ctx.fillStyle = "#f1f5f9";
      ctx.fillRect(0, 0, W, H);

      shadow();
      ctx.fillStyle = "#f6f7f8";
      ctx.strokeStyle = "#d1d5db";
      ctx.lineWidth = 2;
      const x=320, y=190, w=640, h=320;
      ctx.roundRect(x, y, w, h, 18);
      ctx.fill(); ctx.stroke();
      noShadow();

      // top row with traffic lights
      ctx.fillStyle = "#e5e7eb";
      ctx.fillRect(x, y, w, 46);
      ctx.fillStyle = "#ef4444"; ctx.beginPath(); ctx.arc(x+24, y+23, 7, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = "#f59e0b"; ctx.beginPath(); ctx.arc(x+46, y+23, 7, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = "#22c55e"; ctx.beginPath(); ctx.arc(x+68, y+23, 7, 0, Math.PI*2); ctx.fill();

      ctx.fillStyle = "#111827";
      ctx.font = "18px -apple-system, BlinkMacSystemFont, 'SF Pro Text', Arial";
      ctx.fillText(title || "Alerte", x+24, y+90);

      ctx.fillStyle = "#374151";
      ctx.font = "16px -apple-system, BlinkMacSystemFont, 'SF Pro Text', Arial";
      _wrapText(ctx, problem, x+24, y+125, w-48, 24, 6);

      // buttons
      const bw=140, bh=40, gap=12;
      ctx.fillStyle = "#e5e7eb";
      ctx.roundRect(x+w-bw*2-gap-24, y+h-70, bw, bh, 10).fill();
      ctx.roundRect(x+w-bw-24, y+h-70, bw, bh, 10).fill();
      ctx.fillStyle = "#111827";
      ctx.font = "15px -apple-system, BlinkMacSystemFont, 'SF Pro Text', Arial";
      ctx.fillText("Annuler", x+w-bw*2-gap-24+38, y+h-44);
      ctx.fillText("OK", x+w-bw-24+58, y+h-44);

      break;
    }
    case "ios_alert": {
      ctx.fillStyle = "#f8fafc";
      ctx.fillRect(0, 0, W, H);

      shadow();
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.strokeStyle = "rgba(229,231,235,0.9)";
      const x=380, y=190, w=520, h=320;
      ctx.roundRect(x, y, w, h, 24);
      ctx.fill(); ctx.stroke();
      noShadow();

      ctx.fillStyle = "#111827";
      ctx.font = "22px -apple-system, BlinkMacSystemFont, 'SF Pro Display', Arial";
      ctx.textAlign = "center";
      ctx.fillText(title || "Alerte", x+w/2, y+78);

      ctx.fillStyle = "#374151";
      ctx.font = "18px -apple-system, BlinkMacSystemFont, 'SF Pro Text', Arial";
      ctx.textAlign = "center";
      _wrapText(ctx, problem, x+w/2 - (w-80)/2, y+120, w-80, 26, 5);

      // divider
      ctx.strokeStyle = "rgba(209,213,219,0.9)";
      ctx.beginPath(); ctx.moveTo(x, y+h-74); ctx.lineTo(x+w, y+h-74); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(x+w/2, y+h-74); ctx.lineTo(x+w/2, y+h); ctx.stroke();

      ctx.fillStyle = "#0f6cbd";
      ctx.font = "20px -apple-system, BlinkMacSystemFont, 'SF Pro Text', Arial";
      ctx.textAlign = "center";
      ctx.fillText("OK", x+w*0.75, y+h-28);
      ctx.fillStyle = "#111827";
      ctx.fillText("Annuler", x+w*0.25, y+h-28);
      ctx.textAlign = "start";
      break;
    }
    case "android_dialog": {
      ctx.fillStyle = "#eef2f7";
      ctx.fillRect(0, 0, W, H);

      shadow();
      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#e5e7eb";
      const x=420, y=190, w=440, h=320;
      ctx.roundRect(x, y, w, h, 18);
      ctx.fill(); ctx.stroke();
      noShadow();

      ctx.fillStyle = "#111827";
      ctx.font = "20px Roboto, Arial";
      ctx.fillText(title || "Erreur", x+24, y+64);

      ctx.fillStyle = "#374151";
      ctx.font = "16px Roboto, Arial";
      _wrapText(ctx, problem, x+24, y+104, w-48, 24, 6);

      ctx.fillStyle = "#0f766e";
      ctx.font = "16px Roboto, Arial";
      ctx.fillText("ANNULER", x+200, y+h-34);
      ctx.fillText("OK", x+330, y+h-34);
      break;
    }
    case "azure_portal_error": {
      // Azure portal-ish frame
      ctx.fillStyle = "#f3f4f6";
      ctx.fillRect(0, 0, W, H);

      // left nav
      ctx.fillStyle = "#111827";
      ctx.fillRect(0, 0, 240, H);

      // top bar
      ctx.fillStyle = "#1f2937";
      ctx.fillRect(240, 0, W-240, 56);

      ctx.fillStyle = "#ffffff";
      ctx.font = "18px Segoe UI, Arial";
      ctx.fillText("Microsoft Azure", 270, 36);

      // main content
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(260, 86, W-300, H-130);

      // error banner
      ctx.fillStyle = "#fee2e2";
      ctx.fillRect(290, 120, W-360, 72);
      ctx.fillStyle = "#b91c1c";
      ctx.font = "16px Segoe UI, Arial";
      ctx.fillText("Error", 312, 148);
      ctx.fillStyle = "#7f1d1d";
      ctx.font = "14px Segoe UI, Arial";
      _wrapText(ctx, problem, 312, 172, W-420, 20, 2);

      // details pane
      ctx.fillStyle = "#111827";
      ctx.font = "20px Segoe UI, Arial";
      ctx.fillText(title || "Deployment failed", 290, 240);

      ctx.fillStyle = "#374151";
      ctx.font = "14px Segoe UI, Arial";
      _wrapText(ctx, "Try again later, check permissions, and review activity logs.", 290, 270, W-360, 20, 4);
      break;
    }
    case "exchange_outlook_error": {
      ctx.fillStyle = "#e9eef6";
      ctx.fillRect(0, 0, W, H);

      shadow();
      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#e5e7eb";
      const x=250, y=170, w=780, h=380;
      ctx.roundRect(x, y, w, h, 14);
      ctx.fill(); ctx.stroke();
      noShadow();

      // Title bar
      ctx.fillStyle = "#0f6cbd";
      ctx.fillRect(x, y, w, 54);
      ctx.fillStyle = "#ffffff";
      ctx.font = "16px Segoe UI, Arial";
      ctx.fillText("Microsoft Outlook", x+22, y+34);

      // icon
      ctx.fillStyle = "#38bdf8";
      ctx.beginPath(); ctx.arc(x+78, y+160, 26, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = "#0b1220";
      ctx.font = "24px Segoe UI, Arial";
      ctx.fillText("i", x+72, y+170);

      // text
      ctx.fillStyle = "#111827";
      ctx.font = "20px Segoe UI, Arial";
      _wrapText(ctx, problem, x+125, y+142, 580, 30, 6);

      drawButton(x+w-126, y+h-78, 100, 40, "OK", true);
      break;
    }
    case "active_directory_logon": {
      ctx.fillStyle = "#0b1220";
      ctx.fillRect(0, 0, W, H);

      // Simple "Windows logon" box
      shadow();
      ctx.fillStyle = "#111827";
      ctx.strokeStyle = "#334155";
      const x=360, y=180, w=560, h=360;
      ctx.roundRect(x, y, w, h, 16);
      ctx.fill(); ctx.stroke();
      noShadow();

      ctx.fillStyle = "#e5e7eb";
      ctx.font = "20px Segoe UI, Arial";
      ctx.fillText("Windows Security", x+26, y+60);

      ctx.fillStyle = "#94a3b8";
      ctx.font = "14px Segoe UI, Arial";
      _wrapText(ctx, "The user name or password is incorrect.", x+26, y+98, w-52, 20, 2);

      ctx.fillStyle = "#e5e7eb";
      ctx.font = "16px Segoe UI, Arial";
      ctx.fillText("User name:", x+26, y+160);
      ctx.fillText("Password:", x+26, y+230);

      // fields
      ctx.fillStyle = "#0b1220";
      ctx.strokeStyle = "#475569";
      ctx.roundRect(x+26, y+172, w-52, 40, 8); ctx.fill(); ctx.stroke();
      ctx.roundRect(x+26, y+242, w-52, 40, 8); ctx.fill(); ctx.stroke();

      drawButton(x+w-240, y+h-70, 100, 40, "Cancel", false);
      drawButton(x+w-126, y+h-70, 100, 40, "OK", true);

      break;
    }

    case "windows_security_cred": {
      ctx.fillStyle = "#e9eef6";
      ctx.fillRect(0, 0, W, H);

      shadow();
      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#e5e7eb";
      ctx.lineWidth = 2;
      const x=300, y=170, w=680, h=380;
      ctx.roundRect(x, y, w, h, 14); ctx.fill(); ctx.stroke();
      noShadow();

      // Title bar
      ctx.fillStyle = "#f8fafc";
      ctx.fillRect(x, y, w, 54);
      ctx.strokeStyle = "#e5e7eb";
      ctx.beginPath(); ctx.moveTo(x, y+54); ctx.lineTo(x+w, y+54); ctx.stroke();

      ctx.fillStyle = "#111827";
      ctx.font = "16px Segoe UI, Arial";
      ctx.fillText("Windows Security", x+22, y+34);

      // Icon (lock)
      ctx.fillStyle = "#60a5fa";
      ctx.beginPath(); ctx.arc(x+70, y+150, 26, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = "#0b1220";
      ctx.font = "18px Segoe UI, Arial";
      ctx.fillText("üîí", x+58, y+158);

      // Text
      ctx.fillStyle = "#111827";
      ctx.font = "18px Segoe UI, Arial";
      _wrapText(ctx, title, x+120, y+130, 520, 26, 2);

      ctx.fillStyle = "#374151";
      ctx.font = "14px Segoe UI, Arial";
      _wrapText(ctx, problem, x+120, y+170, 520, 20, 3);

      // Fields
      ctx.fillStyle = "#111827";
      ctx.font = "14px Segoe UI, Arial";
      ctx.fillText("User name:", x+120, y+250);
      ctx.fillText("Password:", x+120, y+320);

      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#cbd5e1";
      ctx.roundRect(x+120, y+260, 520, 40, 8); ctx.fill(); ctx.stroke();
      ctx.roundRect(x+120, y+330, 520, 40, 8); ctx.fill(); ctx.stroke();

      // Buttons
      drawButton(x+w-240, y+h-78, 100, 40, "Cancel", false);
      drawButton(x+w-126, y+h-78, 100, 40, "OK", true);
      break;
    }

    case "windows_bsod": {
      // BSOD-like
      ctx.fillStyle = "#0a65c2";
      ctx.fillRect(0, 0, W, H);

      ctx.fillStyle = "#ffffff";
      ctx.font = "72px Segoe UI, Arial";
      ctx.fillText(":(", 180, 200);

      ctx.font = "28px Segoe UI, Arial";
      _wrapText(ctx, "Your device ran into a problem and needs to restart.", 180, 260, 920, 38, 2);
      ctx.font = "20px Segoe UI, Arial";
      _wrapText(ctx, "We‚Äôre just collecting some error info, and then we‚Äôll restart for you.", 180, 330, 920, 30, 2);

      ctx.font = "18px Segoe UI, Arial";
      ctx.fillText("If you call a support person, give them this info:", 180, 410);
      ctx.font = "18px Segoe UI, Arial";
      const stop = (title || "").slice(0, 40) || "STOP CODE: SYSTEM_SERVICE_EXCEPTION";
      ctx.fillText(stop.toUpperCase(), 180, 450);

      // Fake QR
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(980, 390, 110, 110);
      ctx.fillStyle = "#0a65c2";
      for (let i=0;i<11;i++){
        for (let j=0;j<11;j++){
          if ((i*j + i + j) % 3 === 0) ctx.fillRect(985+i*9, 395+j*9, 7, 7);
        }
      }
      break;
    }

    case "macos_keychain": {
      ctx.fillStyle = "#f1f5f9";
      ctx.fillRect(0, 0, W, H);

      shadow();
      ctx.fillStyle = "#f6f7f8";
      ctx.strokeStyle = "#d1d5db";
      ctx.lineWidth = 2;
      const x=320, y=190, w=640, h=340;
      ctx.roundRect(x, y, w, h, 18); ctx.fill(); ctx.stroke();
      noShadow();

      // traffic lights
      ctx.fillStyle = "#e5e7eb";
      ctx.fillRect(x, y, w, 46);
      ctx.fillStyle = "#ef4444"; ctx.beginPath(); ctx.arc(x+24, y+23, 7, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = "#f59e0b"; ctx.beginPath(); ctx.arc(x+46, y+23, 7, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = "#22c55e"; ctx.beginPath(); ctx.arc(x+68, y+23, 7, 0, Math.PI*2); ctx.fill();

      ctx.fillStyle = "#111827";
      ctx.font = "18px -apple-system, BlinkMacSystemFont, 'SF Pro Text', Arial";
      ctx.fillText("Keychain Access", x+24, y+86);

      ctx.fillStyle = "#374151";
      ctx.font = "16px -apple-system, BlinkMacSystemFont, 'SF Pro Text', Arial";
      _wrapText(ctx, problem || "macOS wants to use your confidential information stored in ‚Äúlogin‚Äù in your keychain.", x+24, y+125, w-48, 24, 5);

      ctx.fillStyle = "#111827";
      ctx.font = "14px -apple-system, BlinkMacSystemFont, 'SF Pro Text', Arial";
      ctx.fillText("Password:", x+24, y+250);

      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#cbd5e1";
      ctx.roundRect(x+24, y+262, w-48, 40, 10); ctx.fill(); ctx.stroke();

      // buttons
      ctx.fillStyle = "#e5e7eb";
      ctx.roundRect(x+w-24-140-12-140, y+h-70, 140, 40, 10).fill();
      ctx.roundRect(x+w-24-140, y+h-70, 140, 40, 10).fill();
      ctx.fillStyle = "#111827";
      ctx.font = "15px -apple-system, BlinkMacSystemFont, 'SF Pro Text', Arial";
      ctx.fillText("Cancel", x+w-24-140-12-140+46, y+h-44);
      ctx.fillText("Allow", x+w-24-140+52, y+h-44);
      break;
    }

    case "ios_settings_banner": {
      ctx.fillStyle = "#f8fafc";
      ctx.fillRect(0, 0, W, H);

      // phone frame
      shadow();
      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#e5e7eb";
      const x=420, y=60, w=440, h=600;
      ctx.roundRect(x, y, w, h, 36); ctx.fill(); ctx.stroke();
      noShadow();

      // top bar
      ctx.fillStyle = "#f3f4f6";
      ctx.fillRect(x, y, w, 90);
      ctx.fillStyle = "#111827";
      ctx.font = "20px -apple-system, BlinkMacSystemFont, 'SF Pro Text', Arial";
      ctx.fillText("Settings", x+24, y+58);

      // banner
      ctx.fillStyle = "#fee2e2";
      ctx.fillRect(x+18, y+110, w-36, 76);
      ctx.fillStyle = "#b91c1c";
      ctx.font = "14px -apple-system, BlinkMacSystemFont, 'SF Pro Text', Arial";
      ctx.fillText("Apple ID / Account", x+30, y+140);
      ctx.fillStyle = "#7f1d1d";
      ctx.font = "13px -apple-system, BlinkMacSystemFont, 'SF Pro Text', Arial";
      _wrapText(ctx, problem, x+30, y+162, w-60, 18, 2);
      break;
    }

    case "android_notification": {
      ctx.fillStyle = "#eef2f7";
      ctx.fillRect(0, 0, W, H);

      // phone frame
      shadow();
      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#e5e7eb";
      const x=420, y=60, w=440, h=600;
      ctx.roundRect(x, y, w, h, 28); ctx.fill(); ctx.stroke();
      noShadow();

      // notification shade
      ctx.fillStyle = "#111827";
      ctx.fillRect(x, y, w, 90);
      ctx.fillStyle = "#e5e7eb";
      ctx.font = "16px Roboto, Arial";
      ctx.fillText("Notifications", x+24, y+54);

      // card
      ctx.fillStyle = "#1f2937";
      ctx.roundRect(x+18, y+110, w-36, 110, 16).fill();
      ctx.fillStyle = "#e5e7eb";
      ctx.font = "14px Roboto, Arial";
      ctx.fillText(category || "System", x+36, y+148);
      ctx.font = "16px Roboto, Arial";
      _wrapText(ctx, problem, x+36, y+176, w-72, 22, 3);
      break;
    }

    case "browser_edge_error": {
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, W, H);

      // top browser bar
      ctx.fillStyle = "#f3f4f6";
      ctx.fillRect(0, 0, W, 72);
      ctx.fillStyle = "#111827";
      ctx.font = "16px Segoe UI, Arial";
      ctx.fillText("https://", 120, 44);

      // error content
      ctx.fillStyle = "#111827";
      ctx.font = "40px Segoe UI, Arial";
      ctx.fillText("This site can‚Äôt be reached", 120, 170);

      ctx.fillStyle = "#374151";
      ctx.font = "18px Segoe UI, Arial";
      _wrapText(ctx, problem || "The connection was reset.", 120, 220, 1000, 28, 3);

      ctx.fillStyle = "#6b7280";
      ctx.font = "16px Segoe UI, Arial";
      ctx.fillText("Try:", 120, 330);
      ctx.fillText("‚Ä¢ Checking the connection", 150, 360);
      ctx.fillText("‚Ä¢ Checking the proxy and the firewall", 150, 390);

      ctx.fillStyle = "#6b7280";
      ctx.font = "14px Segoe UI, Arial";
      const code = (title || "ERR_CONNECTION_RESET").toUpperCase();
      ctx.fillText(code, 120, 460);
      break;
    }

    case "teams_error": {
      ctx.fillStyle = "#f3f4f6";
      ctx.fillRect(0, 0, W, H);

      // left rail
      ctx.fillStyle = "#111827";
      ctx.fillRect(0, 0, 220, H);

      // header
      ctx.fillStyle = "#5b5fc7";
      ctx.fillRect(220, 0, W-220, 56);
      ctx.fillStyle = "#ffffff";
      ctx.font = "18px Segoe UI, Arial";
      ctx.fillText("Microsoft Teams", 250, 36);

      // content card
      shadow();
      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#e5e7eb";
      const x=320, y=150, w=820, h=420;
      ctx.roundRect(x, y, w, h, 16); ctx.fill(); ctx.stroke();
      noShadow();

      ctx.fillStyle = "#111827";
      ctx.font = "26px Segoe UI, Arial";
      ctx.fillText(title || "Something went wrong", x+36, y+86);

      ctx.fillStyle = "#374151";
      ctx.font = "18px Segoe UI, Arial";
      _wrapText(ctx, problem || "We couldn‚Äôt sign you in. Please try again.", x+36, y+126, w-72, 28, 5);

      drawButton(x+w-156, y+h-76, 120, 40, "Retry", true);
      break;
    }

    case "vpn_client_error": {
      ctx.fillStyle = "#e9eef6";
      ctx.fillRect(0, 0, W, H);

      shadow();
      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#e5e7eb";
      const x=320, y=170, w=640, h=380;
      ctx.roundRect(x, y, w, h, 14); ctx.fill(); ctx.stroke();
      noShadow();

      ctx.fillStyle = "#111827";
      ctx.font = "18px Segoe UI, Arial";
      ctx.fillText("VPN Client", x+22, y+48);

      ctx.fillStyle = "#374151";
      ctx.font = "16px Segoe UI, Arial";
      _wrapText(ctx, problem || "Unable to establish VPN connection.", x+22, y+92, w-44, 24, 6);

      ctx.fillStyle = "#6b7280";
      ctx.font = "14px Segoe UI, Arial";
      _wrapText(ctx, "Check your network, credentials, and try again.", x+22, y+260, w-44, 20, 2);

      drawButton(x+w-126, y+h-78, 100, 40, "OK", true);
      break;
    }

    case "entra_signin_error": {
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, W, H);

      // Microsoft top
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, W, 84);
      ctx.fillStyle = "#111827";
      ctx.font = "22px Segoe UI, Arial";
      ctx.fillText("Microsoft", 90, 52);

      // content card
      shadow();
      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#e5e7eb";
      const x=340, y=150, w=600, h=420;
      ctx.roundRect(x, y, w, h, 10); ctx.fill(); ctx.stroke();
      noShadow();

      ctx.fillStyle = "#111827";
      ctx.font = "28px Segoe UI, Arial";
      ctx.fillText("Sign-in error", x+40, y+92);

      ctx.fillStyle = "#374151";
      ctx.font = "16px Segoe UI, Arial";
      _wrapText(ctx, problem || "We couldn‚Äôt sign you in. Please try again.", x+40, y+132, w-80, 24, 5);

      ctx.fillStyle = "#6b7280";
      ctx.font = "14px Segoe UI, Arial";
      ctx.fillText("Error code: AADSTS50020", x+40, y+270);
      ctx.fillText("Correlation ID: 00000000-0000-0000-0000-000000000000", x+40, y+296);
      ctx.fillText("Timestamp: " + new Date().toISOString().replace("T"," ").slice(0,19) + "Z", x+40, y+322);

      drawButton(x+w-160, y+h-70, 120, 40, "Try again", true);
      break;
    }
    default: {
      // fallback: Windows dialog
      return generateEnterpriseMockImageDataUrl("windows11_dialog", incident);
    }
  }


  // Watermark to avoid confusion with real screenshots
  ctx.save();
  ctx.globalAlpha = 0.18;
  ctx.fillStyle = "#111827";
  ctx.font = "bold 20px Segoe UI, Arial";
  ctx.translate(W - 210, H - 18);
  ctx.rotate(-0.12);
  ctx.fillText("ILLUSTRATION", 0, 0);
  ctx.restore();

  return c.toDataURL("image/png");
}




document.getElementById("closeImageAiModal")?.addEventListener("click", closeImageAiModal);
document.getElementById("imageAiModal")?.addEventListener("click", (e) => {
  // clic sur l'overlay = ferme
  if (e.target?.id === "imageAiModal") closeImageAiModal();
  if (e.target?.classList?.contains("absolute")) closeImageAiModal();
});

document.getElementById("copyImageAiPrompt")?.addEventListener("click", async () => {
  const promptEl = document.getElementById("imageAiPrompt");
  if (!promptEl) return;
  try {
    await navigator.clipboard.writeText(promptEl.value || "");
    showToast("Prompt copi√© ‚úÖ", "success");
  } catch {
    showToast("Impossible de copier (clipboard bloqu√©).", "error");
  }
});

document.getElementById("clearBase64Input")?.addEventListener("click", () => {
  const base64El = document.getElementById("imageBase64Input");
  if (base64El) base64El.value = "";
});

// -----------------------------
// Drag & drop image -> conversion automatique (base64) + compression + attachement
// -----------------------------
async function fileToCompressedDataURL(file, opts = {}) {
  const {
    maxWidth = 1280,
    maxHeight = 720,
    mime = "image/webp",
    quality = 0.86
  } = opts;

  // S√©curit√© basique
  if (!file || !file.type || !file.type.startsWith("image/")) {
    throw new Error("Fichier non image.");
  }

  // Cr√©e un bitmap (plus fiable que new Image() sur certains navigateurs)
  let bitmap;
  if (window.createImageBitmap) {
    bitmap = await createImageBitmap(file);
  } else {
    // Fallback (anciens navigateurs)
    const dataUrl = await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
    bitmap = await new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = dataUrl;
    });
  }

  // Calcul du resize (conserve ratio)
  let width = bitmap.width;
  let height = bitmap.height;
  const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
  const targetW = Math.max(1, Math.round(width * ratio));
  const targetH = Math.max(1, Math.round(height * ratio));

  const canvas = document.createElement("canvas");
  canvas.width = targetW;
  canvas.height = targetH;

  const ctx = canvas.getContext("2d", { alpha: true });
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = "high";
  ctx.clearRect(0, 0, targetW, targetH);
  ctx.drawImage(bitmap, 0, 0, targetW, targetH);

  // webp support check -> fallback PNG
  const outMime = (mime === "image/webp" && !canvas.toDataURL("image/webp").startsWith("data:image/webp"))
    ? "image/png"
    : mime;

  const dataUrl = canvas.toDataURL(outMime, quality);
  return dataUrl;
}

function setImagePreview(dataUrl) {
  const prev = document.getElementById("imageDropPreview");
  if (!prev) return;
  prev.src = dataUrl;
  prev.classList.remove("hidden");
}

function attachDataUrlToTargetIncident(dataUrl) {
  if (!dataUrl || typeof dataUrl !== "string" || !dataUrl.startsWith("data:image/")) {
    showToast("Image invalide (data:image/...).", "error");
    return false;
  }

  const inc = getIncidentById(_imageAiTargetIncidentId);
  if (!inc) {
    showToast("Ouvre d‚Äôabord la suggestion IA depuis une fiche.", "error");
    return false;
  }

  inc.image = dataUrl;
  inc.updatedAt = new Date().toISOString();
  saveIncidentsToStorage();
  renderCards();
  showToast("Image attach√©e ‚úÖ", "success");
  return true;
}

function bindDragDropImageZone() {
  const dz = document.getElementById("imageDropZone");
  const fi = document.getElementById("imageFileInput");
  const base64El = document.getElementById("imageBase64Input");
  if (!dz || !fi) return;

  const highlight = (on) => {
    dz.classList.toggle("border-sky-400/80", !!on);
    dz.classList.toggle("bg-slate-900/55", !!on);
  };

  dz.addEventListener("click", () => fi.click());

  dz.addEventListener("dragover", (e) => {
    e.preventDefault();
    highlight(true);
  });
  dz.addEventListener("dragleave", () => highlight(false));
  dz.addEventListener("drop", async (e) => {
    e.preventDefault();
    highlight(false);
    const file = e.dataTransfer?.files?.[0];
    if (!file) return;

    try {
      showToast("Conversion de l‚Äôimage‚Ä¶", "info");
      const dataUrl = await fileToCompressedDataURL(file, {
        maxWidth: 1280,
        maxHeight: 720,
        mime: "image/webp",
        quality: 0.86
      });

      if (base64El) base64El.value = dataUrl;
      setImagePreview(dataUrl);

      // Attache automatiquement (ultra propre)
      const ok = attachDataUrlToTargetIncident(dataUrl);
      if (ok) closeImageAiModal();
    } catch (err) {
      console.error(err);
      showToast("Impossible de traiter l‚Äôimage.", "error");
    }
  });

  fi.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      showToast("Conversion de l‚Äôimage‚Ä¶", "info");
      const dataUrl = await fileToCompressedDataURL(file, {
        maxWidth: 1280,
        maxHeight: 720,
        mime: "image/webp",
        quality: 0.86
      });

      if (base64El) base64El.value = dataUrl;
      setImagePreview(dataUrl);

      const ok = attachDataUrlToTargetIncident(dataUrl);
      if (ok) closeImageAiModal();
    } catch (err) {
      console.error(err);
      showToast("Impossible de traiter l‚Äôimage.", "error");
    } finally {
      // permet de re-s√©lectionner le m√™me fichier
      e.target.value = "";
    }
  });
}
bindDragDropImageZone();


document.getElementById("generateMockImageBtn")?.addEventListener("click", () => {
  const templateSel = document.getElementById("mockTemplateSelect");
  const template = (templateSel?.value || "windows11_dialog").trim();
  if (!_imageAiTargetIncidentId) {
    showToast("Aucune fiche cibl√©e.", "error");
    return;
  }
  const incident = incidents.find(i => String(i.id) === String(_imageAiTargetIncidentId));
  if (!incident) {
    showToast("Fiche introuvable.", "error");
    return;
  }

  try {
    const dataUrl = generateEnterpriseMockImageDataUrl(template, incident);
    // preview + textarea
    const base64El = document.getElementById("imageBase64Input");
    const preview = document.getElementById("imageDropPreview");
    if (base64El) base64El.value = dataUrl;

    if (preview) {
      preview.src = dataUrl;
      preview.classList.remove("hidden");
    }

    // attach immediately
    incident.image = dataUrl;
    incident.updatedAt = new Date().toISOString();
    saveIncidentsToStorage();
    renderCards();

    showToast("Mock screenshot attach√© ‚úÖ", "success");
    closeImageAiModal();
  } catch (e) {
    console.error(e);
    showToast("√âchec g√©n√©ration mock screenshot.", "error");
  }
});

document.getElementById("attachBase64ToIncident")?.addEventListener("click", () => {
  const base64El = document.getElementById("imageBase64Input");
  const val = (base64El?.value || "").trim();
  if (!val) {
    showToast("Colle un data-URI base64 d‚Äôabord.", "error");
    return;
  }
  if (!val.startsWith("data:image/") || !val.includes(";base64,")) {
    showToast("Format attendu : data:image/...;base64,...", "error");
    return;
  }

  const inc = getIncidentById(_imageAiTargetIncidentId);
  if (!inc) {
    showToast("Fiche introuvable.", "error");
    return;
  }

  inc.image = val;
  inc.updatedAt = new Date().toISOString();
  saveIncidentsToStorage();
  renderCards();
  showToast("Image attach√©e ‚úÖ", "success");
  closeImageAiModal();
});

async function handleExternalAISuggestion() {
  const term = state.search || "";
  if (!term) {
    showToast("Aucun terme de recherche pour interroger l'IA externe.", "error");
    return;
  }

  // Pour l‚Äôinstant : simple placeholder
  alert(
    "Aucune fiche interne ou du pool ne correspond.\n\n" +
    "Ici, on pourra appeler une IA externe (API) pour g√©n√©rer une fiche au bon format."
  );
}


function renderCards() {
  cardsContainer.innerHTML = "";

  const filtered = incidents.filter(
    inc => matchesFilters(inc) && matchesSearch(inc, state.search)
  );

  countVisible.textContent = filtered.length.toString();

  if (filtered.length === 0) {
    noResults.classList.remove("hidden");
    return;
  } else {
    noResults.classList.add("hidden");
  }

  filtered.forEach(incident => {
    const card = document.createElement("article");
    card.className =
      "glass rounded-2xl border border-slate-700/80 p-3 sm:p-4 flex flex-col gap-2 card-hover transition-fast";
    card.dataset.id = incident.id;

    const header = document.createElement("div");
header.className = "flex items-start justify-between gap-2";

const titleBox = document.createElement("div");
titleBox.className = "max-w-[45%]";

const titleEl = document.createElement("h3");
titleEl.className =
  "text-sm sm:text-base font-semibold text-sky-100 break-words";
titleEl.className = "text-sm sm:text-base font-semibold text-sky-100";
titleEl.textContent = incident.title;

const metaRow = document.createElement("div");
metaRow.className = "mt-1 flex flex-wrap items-center gap-2";

const catSpan = document.createElement("span");
catSpan.className =
  "category-chip bg-slate-800/80 text-sky-300 border border-sky-500/70";
catSpan.textContent = incident.category;

const lvlSpan = document.createElement("span");
lvlSpan.className =
  "inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[0.65rem] uppercase tracking-wide " +
  getLevelBadgeClass(incident.level);
lvlSpan.innerHTML = "";
const lvlDot = document.createElement("span");
lvlDot.className = "w-1.5 h-1.5 rounded-full bg-slate-900/80";
const lvlTxt = document.createElement("span");
lvlTxt.textContent = incident.level;
lvlSpan.appendChild(lvlDot);
lvlSpan.appendChild(lvlTxt);

metaRow.appendChild(catSpan);
metaRow.appendChild(lvlSpan);
titleBox.appendChild(titleEl);
titleBox.appendChild(metaRow);

// auteur + dates
const infoRow = document.createElement("div");
infoRow.className = "mt-1 flex flex-wrap items-center gap-2 text-[0.7rem] text-slate-400";

if (incident.author) {
  const authorEl = document.createElement("span");
  authorEl.textContent = `Auteur : ${incident.author}`;
  infoRow.appendChild(authorEl);
}
if (incident.createdAt) {
  const createdEl = document.createElement("span");
  const createdDate = new Date(incident.createdAt);
  createdEl.textContent = `Cr√©√©e le : ${createdDate.toLocaleDateString()}`;
  infoRow.appendChild(createdEl);
}
if (incident.updatedAt && incident.updatedAt !== incident.createdAt) {
  const updatedEl = document.createElement("span");
  const updatedDate = new Date(incident.updatedAt);
  updatedEl.textContent = `Modifi√©e le : ${updatedDate.toLocaleDateString()}`;
  infoRow.appendChild(updatedEl);
}
if (infoRow.childElementCount > 0) {
  titleBox.appendChild(infoRow);
}

// bouton d√©tails
const toggleBtn = document.createElement("button");
toggleBtn.type = "button";
toggleBtn.className =
  "inline-flex items-center text-[0.7rem] uppercase tracking-wide text-slate-300 bg-slate-900/60 border border-slate-500/80 rounded-full px-2 py-1 hover:bg-slate-800/80 transition-fast";
toggleBtn.innerHTML =
  '<span class="mr-1 rotate-icon">‚ñ∂</span><span>D√©tails</span>';

// Accessibilit√© : √©tat + clavier
toggleBtn.setAttribute("aria-expanded", "false");
toggleBtn.addEventListener("keydown", e => {
  if (e.key === "Enter" || e.key === " ") {
    e.preventDefault();
    toggleBtn.click();
  }
});

// actions √† droite
const actions = document.createElement("div");
actions.className =
  "flex flex-wrap items-center gap-1 justify-end max-w-[55%]";

actions.appendChild(toggleBtn);

// bouton favoris
const favBtn = document.createElement("button");
favBtn.type = "button";
favBtn.className =
  "text-xs px-2 py-1 rounded-full border border-slate-500/60 bg-slate-900/60 hover:bg-slate-800/90 transition-fast";
favBtn.textContent = incident.favorite ? "‚òÖ" : "‚òÜ";
favBtn.addEventListener("click", e => {
  e.stopPropagation();
  incident.favorite = !incident.favorite;
  saveIncidentsToStorage();
  renderFilters();
  renderCards();
});
actions.appendChild(favBtn);

// bouton Modifier
const editBtn = document.createElement("button");
editBtn.type = "button";
editBtn.className =
  "text-[0.7rem] px-2 py-1 rounded-full border border-sky-500/70 text-sky-200 bg-slate-900/60 hover:bg-slate-800/80 transition-fast";
editBtn.textContent = "Modifier";
editBtn.addEventListener("click", e => {
  e.stopPropagation();
  startEditIncident(incident.id);
});
actions.appendChild(editBtn);

// bouton Supprimer
const deleteBtn = document.createElement("button");
deleteBtn.type = "button";
deleteBtn.className =
  "text-[0.7rem] px-2 py-1 rounded-full border border-red-500/70 text-red-200 bg-slate-900/60 hover:bg-red-900/70 transition-fast";
deleteBtn.textContent = "Supprimer";
deleteBtn.addEventListener("click", e => {
  e.stopPropagation();
  const ok = confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer cette fiche ? Cette action est irr√©versible.");
  if (!ok) return;
  deleteIncidentById(incident.id);
  saveIncidentsToStorage();
  renderCards();
  showToast("Fiche supprim√©e ‚úÖ", "success");
});
actions.appendChild(deleteBtn);

// bouton Imprimer (fiche seule)
const printBtn = document.createElement("button");
printBtn.type = "button";
printBtn.className =
  "text-[0.7rem] px-2 py-1 rounded-full border border-slate-500/60 text-slate-200 bg-slate-900/60 hover:bg-slate-800/80 transition-fast";
printBtn.textContent = "Imprimer";
printBtn.addEventListener("click", e => {
  e.stopPropagation();
  printSingleIncident(incident.id);
});
actions.appendChild(printBtn);

header.appendChild(titleBox);
header.appendChild(actions);



    const problemEl = document.createElement("p");
    problemEl.className = "text-xs text-slate-300";
    problemEl.textContent = incident.problem;

    // Image √©ventuelle
    if (incident.image) {
      const imgWrapper = document.createElement("div");
      imgWrapper.className = "mt-2 rounded-xl overflow-hidden border border-slate-700/80";

      const img = document.createElement("img");
      img.src = incident.image;
      img.alt = "Illustration de la panne";
      img.className = "w-full h-32 object-cover";

      // Si l'image ne charge pas, on propose une suggestion IA (sans casser la carte)
      img.onerror = () => {
        imgWrapper.innerHTML = "";
        imgWrapper.className = "mt-2 rounded-xl border border-slate-700/80 p-3 bg-slate-900/40";
        const msg = document.createElement("p");
        msg.className = "text-[11px] text-slate-400";
        msg.textContent = "Image introuvable. G√©n√®re/attache une image via suggestion IA.";
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "mt-2 px-3 py-2 rounded-xl glass text-xs font-semibold text-amber-100 border border-amber-400/40 hover:bg-slate-800/80 transition-fast";
        btn.textContent = "‚ú® Proposer une image IA";
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          openImageAiModal(incident);
        });
        imgWrapper.appendChild(msg);
        imgWrapper.appendChild(btn);
      };

      imgWrapper.appendChild(img);
      card.appendChild(imgWrapper);
    } else {
      // Pas d'image : proposer directement
      const imgWrapper = document.createElement("div");
      imgWrapper.className = "mt-2 rounded-xl border border-slate-700/80 p-3 bg-slate-900/40";
      const msg = document.createElement("p");
      msg.className = "text-[11px] text-slate-400";
      msg.textContent = "Aucune image. G√©n√®re/attache une image via suggestion IA.";
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "mt-2 px-3 py-2 rounded-xl glass text-xs font-semibold text-amber-100 border border-amber-400/40 hover:bg-slate-800/80 transition-fast";
      btn.textContent = "‚ú® Proposer une image IA";
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        openImageAiModal(incident);
      });
      imgWrapper.appendChild(msg);
      imgWrapper.appendChild(btn);
      card.appendChild(imgWrapper);
    }

    // Tags √©ventuels
    if (incident.tags && incident.tags.length > 0) {
      const tagsRow = document.createElement("div");
      tagsRow.className = "mt-1 flex flex-wrap gap-1";
      incident.tags.forEach(tag => {
        const span = document.createElement("span");
        span.className =
          "px-1.5 py-0.5 rounded-full bg-slate-800/80 text-[0.65rem] text-sky-200";
        span.textContent = `#${tag}`;
        tagsRow.appendChild(span);
      });
      card.appendChild(tagsRow);
    }

    const details = document.createElement("div");
    details.className = "mt-2 space-y-2 text-xs text-slate-300 hidden";

    const rootCauseEl = document.createElement("div");
    {
      const t = document.createElement("p");
      t.className = "text-[0.7rem] font-semibold text-slate-400 uppercase mb-0.5";
      t.textContent = "Root Cause";
      const p = document.createElement("p");
      p.className = "text-xs text-slate-300";
      p.textContent = incident.rootCause || "";
      rootCauseEl.appendChild(t);
      rootCauseEl.appendChild(p);
    }

    const workaroundEl = document.createElement("div");
    {
      const t = document.createElement("p");
      t.className = "text-[0.7rem] font-semibold text-slate-400 uppercase mb-0.5";
      t.textContent = "Solution de contournement";
      const p = document.createElement("p");
      p.className = "text-xs text-slate-300";
      p.textContent = incident.workaround || "";
      workaroundEl.appendChild(t);
      workaroundEl.appendChild(p);
    }

    const solutionEl = document.createElement("div");
    {
      const t = document.createElement("p");
      t.className = "text-[0.7rem] font-semibold text-slate-400 uppercase mb-0.5";
      t.textContent = "Solution d√©finitive";
      const p = document.createElement("p");
      p.className = "text-xs text-slate-300";
      p.textContent = incident.solution || "";
      solutionEl.appendChild(t);
      solutionEl.appendChild(p);
    }

    const stepsEl = document.createElement("div");
    const stepsTitle = document.createElement("p");
    stepsTitle.className =
      "text-[0.7rem] font-semibold text-slate-400 uppercase mb-0.5";
    stepsTitle.textContent = "Fiche de d√©pannage (√©tapes)";
    const stepsList = document.createElement("ol");
    stepsList.className = "list-decimal list-inside space-y-0.5";
    (incident.steps || []).forEach(step => {
      const li = document.createElement("li");
      li.textContent = step;
      stepsList.appendChild(li);
    });
    stepsEl.appendChild(stepsTitle);
    stepsEl.appendChild(stepsList);

    details.appendChild(rootCauseEl);
    details.appendChild(workaroundEl);
    details.appendChild(solutionEl);
    details.appendChild(stepsEl);

    card.appendChild(header);
    card.appendChild(problemEl);
    card.appendChild(details);

    // Toggle behaviour
    toggleBtn.addEventListener("click", () => {
      const isHidden = details.classList.contains("hidden");
      if (isHidden) {
        details.classList.remove("hidden");
        card.classList.add("details-open");
        toggleBtn.setAttribute("aria-expanded", "true");
      } else {
        details.classList.add("hidden");
        card.classList.remove("details-open");
        toggleBtn.setAttribute("aria-expanded", "false");
      }
    });

    card.addEventListener("click", e => {
      if (e.target.closest("button")) return;
      toggleBtn.click();
    });

    cardsContainer.appendChild(card);
  });
}

function fillFormWithIncident(incident) {
  const form = document.getElementById("addIncidentForm");
  form.querySelector('[name="title"]').value = incident.title || "";
  form.querySelector('[name="category"]').value = incident.category || "";
  form.querySelector('[name="level"]').value = incident.level || "";
  if (form.querySelector('[name="author"]')) {
    form.querySelector('[name="author"]').value = incident.author || "";
  }
  if (form.querySelector('[name="image"]')) {
    form.querySelector('[name="image"]').value = incident.image || "";
  }
  if (form.querySelector('[name="tags"]')) {
    form.querySelector('[name="tags"]').value = (incident.tags || []).join(", ");
  }
  form.querySelector('[name="problem"]').value = incident.problem || "";
  form.querySelector('[name="rootCause"]').value = incident.rootCause || "";
  form.querySelector('[name="workaround"]').value = incident.workaround || "";
  form.querySelector('[name="solution"]').value = incident.solution || "";
  form.querySelector('[name="steps"]').value = (incident.steps || []).join("\n");
}

function resetFormToCreateMode() {
  const form = document.getElementById("addIncidentForm");
  form.reset();
  editingIncidentId = null;
  const submitBtn = document.getElementById("submitIncidentBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  if (submitBtn) submitBtn.textContent = "Ajouter la fiche";
  if (cancelEditBtn) cancelEditBtn.classList.add("hidden");
}

function startEditIncident(id) {
  const incident = getIncidentById(id);
  if (!incident) return;
  editingIncidentId = id;
  fillFormWithIncident(incident);
  const submitBtn = document.getElementById("submitIncidentBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  if (submitBtn) submitBtn.textContent = "üíæ Enregistrer les modifications";
  if (cancelEditBtn) cancelEditBtn.classList.remove("hidden");
  document.getElementById("addIncidentForm")?.scrollIntoView({ behavior: "smooth" });
}
function printSingleIncident(id) {
  const originalFavoritesOnly = state.favoritesOnly;
  const originalSearch = state.search;
  const originalCategory = state.category;
  const originalLevel = state.level;

  state.favoritesOnly = false;
  state.search = "";
  state.category = "ALL";
  state.level = "ALL";

  const target = incidents.find(inc => inc.id === id);
  if (!target) return;

  const backup = incidents.slice();
  incidents.length = 0;
  incidents.push(target);
  renderCards();

  // S'assure que les d√©tails sont visibles pour l'impression
  document.querySelectorAll("#cardsContainer article").forEach(card => {
    const details = card.querySelector("div.mt-2.space-y-2.text-xs.text-slate-300");
    if (details) details.classList.remove("hidden");
    card.classList.add("details-open");
    const btn = card.querySelector('button[aria-expanded]');
    if (btn) btn.setAttribute("aria-expanded", "true");
  });

  window.print();

  incidents.length = 0;
  backup.forEach(i => incidents.push(i));
  state.favoritesOnly = originalFavoritesOnly;
  state.search = originalSearch;
  state.category = originalCategory;
  state.level = originalLevel;
  renderCards();
}

document.getElementById("printAllBtn").addEventListener("click", () => {
  // Ouvrir tous les d√©tails avant impression
  const openedIds = [];
  document.querySelectorAll("#cardsContainer article").forEach(card => {
    const details = card.querySelector("div.mt-2.space-y-2.text-xs.text-slate-300");
    if (!details) return;
    if (details.classList.contains("hidden")) {
      details.classList.remove("hidden");
      card.classList.add("details-open");
      openedIds.push(card.dataset.id);
      const btn = card.querySelector('button[aria-expanded]');
      if (btn) btn.setAttribute("aria-expanded", "true");
    }
  });

  const restore = () => {
    document.querySelectorAll("#cardsContainer article").forEach(card => {
      if (!openedIds.includes(card.dataset.id)) return;
      const details = card.querySelector("div.mt-2.space-y-2.text-xs.text-slate-300");
      if (!details) return;
      details.classList.add("hidden");
      card.classList.remove("details-open");
      const btn = card.querySelector('button[aria-expanded]');
      if (btn) btn.setAttribute("aria-expanded", "false");
    });
    window.removeEventListener("afterprint", restore);
  };

  window.addEventListener("afterprint", restore);
  window.print();
});

// -----------------------------
// Recherche
// -----------------------------
document.getElementById("searchInput").addEventListener("input", e => {
  state.search = e.target.value || "";
  renderCards();
});

// -----------------------------
// Formulaire d'ajout
// -----------------------------
document
  .getElementById("addIncidentForm")
  .addEventListener("submit", e => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    const tagsRaw = (formData.get("tags") || "").trim();
    const now = new Date().toISOString();

    const baseData = {
      title: formData.get("title").trim(),
      category: formData.get("category"),
      level: formData.get("level"),
      author: (formData.get("author") || "").trim() || null,
      image: (formData.get("image") || "").trim() || null,
      problem: formData.get("problem").trim(),
      rootCause: formData.get("rootCause").trim(),
      workaround: formData.get("workaround").trim(),
      solution: formData.get("solution").trim(),
      tags: tagsRaw
        ? tagsRaw.split(",").map(s => s.trim()).filter(Boolean)
        : [],
      steps: formData
        .get("steps")
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean)
    };

    if (editingIncidentId != null) {
      const existing = getIncidentById(editingIncidentId);
      if (existing) {
        Object.assign(existing, baseData, {
          createdAt: existing.createdAt || now,
          updatedAt: now
        });
      }
    } else {
      const newIncident = {
        id: nextId++,
        favorite: false,
        createdAt: now,
        updatedAt: now,
        ...baseData
      };
      incidents.unshift(newIncident);
    }

    saveIncidentsToStorage();
    renderFilters();
    renderCards();
    resetFormToCreateMode();
	if (editingIncidentId != null) {
  showToast("Fiche modifi√©e avec succ√®s ‚úÖ", "success");
} else {
  showToast("Nouvelle fiche ajout√©e ‚úÖ", "success");
}

  });

document.getElementById("cancelEditBtn").addEventListener("click", () => {
  resetFormToCreateMode();
});



// -----------------------------
// Suggestion IA (interne + crochet externe)
// -----------------------------
document.getElementById("aiSuggestionBtn").addEventListener("click", async () => {
  // 1) IA interne : on cherche d‚Äôabord dans le pool
  const suggestion = suggestFromPool();

  if (suggestion) {
    const now = new Date().toISOString();
    const newIncident = {
      ...suggestion,
      id: nextId++,
      favorite: false,
      createdAt: now,
      updatedAt: now
    };

    incidents.unshift(newIncident);
    saveIncidentsToStorage();
    renderCards();
    showToast("Suggestion IA ajout√©e depuis le pool interne ‚úÖ", "success");

    const btn = document.getElementById("aiSuggestionBtn");
    btn.classList.add("scale-95");
    setTimeout(() => btn.classList.remove("scale-95"), 150);
    return;
  }

  // 2) Si le pool ne retourne rien : IA externe (placeholder)
  await handleExternalAISuggestion();
});


// -----------------------------
// Export / Import JSON
// -----------------------------
document.getElementById("exportBtn").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(incidents, null, 2)], { type: "application/json" });

document.getElementById("exportWithImagesBtn").addEventListener("click", () => {
  // Export avec images embarqu√©es si possible.
  // Si l'image est d√©j√† un data-URI => ok.
  // Si l'image est un chemin/URL => on exporte tel quel (sans t√©l√©chargement r√©seau).
  const payload = incidents.map(inc => {
    const copy = { ...inc };
    // Marqueur utile
    copy.imageEmbedded = typeof copy.image === "string" && copy.image.startsWith("data:image/");
    if (!copy.imageEmbedded) {
      // on propose un prompt si image manquante
      if (!copy.image) {
        copy.imageSuggestionPrompt = buildImageSuggestionPrompt(copy);
      }
    }
    return copy;
  });

  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "total-troubleshooting-incidents_with_images.json";
  a.click();
  URL.revokeObjectURL(url);
  showToast("Export (avec images) g√©n√©r√© ‚úÖ", "success");
});

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "total-troubleshooting-incidents.json";
  a.click();
  URL.revokeObjectURL(url);
});

function mergeImportedIncidents(imported) {
  imported.forEach(newInc => {
    // Crit√®re d‚Äôunicit√© : le titre (tu peux ajouter l‚Äôimage si tu veux)
    const existingIndex = incidents.findIndex(
      inc => inc.title === newInc.title
      // || (inc.image && newInc.image && inc.image === newInc.image)
    );

    if (existingIndex === -1) {
      // Nouveau : on ajoute avec un id unique
      const maxId = incidents.reduce((max, i) => Math.max(max, i.id || 0), 0);
      if (!newInc.id || newInc.id <= maxId) {
        newInc.id = maxId + 1;
      }
      if (typeof newInc.favorite !== "boolean") {
        newInc.favorite = false;
      }
      incidents.push(newInc);
    } else {
      // Doublon : on propose de remplacer
      const ok = window.confirm(
        `Une fiche avec le titre "${newInc.title}" existe d√©j√†.\n\n` +
        `Veux-tu la remplacer par celle du fichier import√© ?`
      );
      if (ok) {
        // On conserve l'id d‚Äôorigine pour ne rien casser
        const oldId = incidents[existingIndex].id;
        const oldFavorite = incidents[existingIndex].favorite || false;

        const merged = {
          ...incidents[existingIndex],
          ...newInc
        };

        merged.id = oldId;
        if (typeof merged.favorite !== "boolean") {
          merged.favorite = oldFavorite;
        }

        incidents[existingIndex] = merged;
      }
    }
  });

  nextId = incidents.reduce((max, i) => Math.max(max, i.id || 0), 0) + 1;
  saveIncidentsToStorage();
  renderFilters();
  renderCards();
}

document.getElementById("importInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try {
      const raw = JSON.parse(reader.result);
      if (!Array.isArray(raw)) {
        console.error("Import JSON : racine non-array", raw);
        showToast("Le fichier JSON doit contenir un tableau de fiches.", "error");
        return;
      }

      const required = [
        "title",
        "category",
        "level",
        "problem",
        "rootCause",
        "workaround",
        "solution"
      ];

      const normalized = raw
        .map(item => {
          if (!item || typeof item !== "object") return null;

          for (const key of required) {
            if (!item[key] || typeof item[key] !== "string") {
              console.error("Fiche invalide (champ manquant) :", key, item);
              return null;
            }
          }

          // normalisation steps
          if (typeof item.steps === "string") {
            item.steps = item.steps
              .split(/\r?\n/)
              .map(s => s.trim())
              .filter(Boolean);
          } else if (Array.isArray(item.steps)) {
            item.steps = item.steps
              .map(s => (typeof s === "string" ? s.trim() : ""))
              .filter(Boolean);
          } else {
            item.steps = [];
          }

          // normalisation tags (si string => CSV)
          if (typeof item.tags === "string") {
            item.tags = item.tags
              .split(",")
              .map(s => s.trim())
              .filter(Boolean);
          } else if (!Array.isArray(item.tags)) {
            item.tags = [];
          }

          // trims (sans changer le contenu)
          item.title = item.title.trim();
          item.category = item.category.trim();
          item.level = item.level.trim();
          item.problem = item.problem.trim();
          item.rootCause = item.rootCause.trim();
          item.workaround = item.workaround.trim();
          item.solution = item.solution.trim();

          return item;
        })
        .filter(Boolean);

      if (!normalized.length) {
        showToast("Aucune fiche valide √† importer.", "error");
        return;
      }

      mergeImportedIncidents(normalized);
      // Met √† jour filtres + datalist (cat√©gories dynamiques)
      renderFilters();
      showToast(`Import r√©ussi : ${normalized.length} fiche(s).`, "success");
    } catch (err) {
      console.error("Erreur lors de l'import JSON :", err);
      showToast("Erreur lors de la lecture du fichier JSON.", "error");
    } finally {
      // permet de r√©importer le m√™me fichier
      e.target.value = "";
    }
  };

  reader.readAsText(file, "utf-8");
});

// -----------------------------
// Reset complet
// -----------------------------
document.getElementById("resetBtn").addEventListener("click", () => {
  const ok = confirm("Tu confirmes la r√©initialisation compl√®te de la biblioth√®que ?");
  if (!ok) return;

  incidents.length = 0;            // vide le tableau en place
  nextId = 1;
  localStorage.removeItem(STORAGE_KEY);
  renderCards();
});

// -----------------------------
// Initialisation
// -----------------------------
loadIncidentsFromStorage();
renderFilters();
renderCards();
</script>

</body>
</html>
